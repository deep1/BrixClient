<html>
	<head>
		<title>IFrame</title>
		<script src="../js/eventmanager_ex.js"></script>
	</head>
	<body>
		<script >

			var iframeID = getParameterByName("id");

			var rxMessageCtr = 0;

            var eventManager = new EventManager();

            eventManager.subscribe("topicTest", function(content) {
            	rxMessageCtr++;

            	/* Sending message to the master page to assert unit test */
				window.parent.postMessage({
		            messageType:"unittest",
		            originId:iframeID,
		            rcvCounter:rxMessageCtr
		        }, '*');

            	console.log("[" + iframeID + "] Rx: " + rxMessageCtr);
            });
	        eventManager.listenBroker();

			window.onload = function(){
				window.parent.postMessage({
		            messageType:"bricevent",
		            message: {
				 		sendTime:"2013-05-27T12:00:01",
				 		topic:"topicTest",
						eventData: {value:25}
				 	}
		        }, '*');
				
		        //listenBroker(iframeID);
		    }


	        /**
	         * Start listening to the broker messages
	         */
	        function listenBroker(iframeID)
			{
				window.addEventListener('message', function(e){
					var data = e.data;
					if (data.messageType === 'bricevent'){
console.log("["+iframeID+"] EventManager: Handling bricevent:" + JSON.stringify(data));
					}
				});
			}

			/**
			 * Get parameter from the url
			 */
			function getParameterByName(name) {
			    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
			    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
			        results = regex.exec(location.search);
			    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
			}
		</script>
		Hello, Im Bric mock
	</body>
</html>
