<html>
	<head>
		<title>IFrame</title>
		<script src="../../closure/closure-library/closure/goog/base.js"></script>
    	<script src="../../closure/closure-library/closure/goog/deps.js"></script>
		<script src="../js/eventmanager.js"></script>
	</head>
	<body>
		<script >

			var iframeID = getParameterByName("id");

			var subscribeTopic = getParameterByName("sub");
			if (!subscribeTopic) {
				subscribeTopic = "topicTest";
			}

			var publishTopic = getParameterByName("pub");
			if (!publishTopic) {
				publishTopic = "topicTest";
			}
			
			var rxMessageCtr = 0;

            var eventManager = new pearson.utils.EventManager();


			window.onload = function(){
				eventManager.subscribe(subscribeTopic, function(content) {
	            	rxMessageCtr++;

	            	/* Sending message to the master page to assert unit test */
					window.parent.postMessage({
			            channel:"unittest",
			            originId:iframeID,
			            rcvCounter:rxMessageCtr
			        }, '*');

	            	console.log("[" + iframeID + "] Rx: " + rxMessageCtr + ", data=" + content.value);
	            });

		        eventManager.listenBroker();

		        setTimeout(function(){
		        	var dataVal = 'testval' + iframeID;
		        	console.log("[" + iframeID + "] Publishing");
	                eventManager.publish(publishTopic, {value:dataVal});
	         
	            }, 200);

		        /*
				window.parent.postMessage({
		            channel:"bricevent",
		            message: {
				 		sendTime:"2013-05-27T12:00:01",
				 		topic:"topicTest",
						eventData: {value:'testval'}
				 	}
		        }, '*');*/
				
		    }


			/**
			 * Get parameter from the url
			 */
			function getParameterByName(name) {
			    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
			    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
			        results = regex.exec(location.search);
			    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
			}
		</script>
		Hello, Im Bric mock
	</body>
</html>
