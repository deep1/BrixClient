//Copyright 2012, etc.

/**
 * almond 0.1.2 Copyright (c) 2011, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
		 *
		 * @fileoverview Implementation of the utility functions and objects
		 *               used by widgets.
		 *
		 * Created on		March 27, 2013
		 * @author			Leslie Bondaryk
		 * @author			Michael Jay Lippert
		 *
		 * Copyright (c) 2013 Pearson, All rights reserved.
		 *
		 * **************************************************************************/

/**
	 *
	 * @fileoverview Implementation of the callout widget.
	 *
	 * The callout widget creates sequential keyed blobs of HTML for highlight
	 * association with a labeled, keyed image.  Can be shown individually or as 
	 * a table.
	 *
	 * Created on		April 16, 2013
	 * @author			Leslie Bondaryk
	 * @author			Michael Jay Lippert
	 *
	 * Copyright (c) 2013 Pearson, All rights reserved.
	 *
	 * **************************************************************************/

/**
		 *
		 * @fileoverview Implementation of the Image widget.
		 *
		 * The Image widget draws a scaled image in an SVGContainer.
		 * The CaptionedImage widget draws a caption next to an Image.
		 *
		 * Created on		May 04, 2013
		 * @author			Leslie Bondaryk
		 * @author			Michael Jay Lippert
		 *
		 * Copyright (c) 2013 Pearson, All rights reserved.
		 *
		 * **************************************************************************/

/**
	 *
	 * @fileoverview Implementation of the LabelGroup widget.
	 *
	 * The LabelGroup widget draws a group of labels at specified locations
	 * in an SVGContainer.
	 *
	 * Created on		April 23, 2013
	 * @author			Leslie Bondaryk
	 * @author			Michael Jay Lippert
	 *
	 * Copyright (c) 2013 Pearson, All rights reserved.
	 *
	 * **************************************************************************/

(function(e,t){typeof define=="function"&&define.amd?define(["jquery","underscore","d3"],t):e.interactives=t(e.$,e._,e.d3)})(this,function(e,t,n){var r,i,s;return function(e){function c(e,t){var n=t&&t.split("/"),r=o.map,i=r&&r["*"]||{},s,u,a,f,l,c,h,p,d,v;if(e&&e.charAt(0)==="."&&t){n=n.slice(0,n.length-1),e=n.concat(e.split("/"));for(p=0;v=e[p];p++)if(v===".")e.splice(p,1),p-=1;else if(v===".."){if(p===1&&(e[2]===".."||e[0]===".."))return!0;p>0&&(e.splice(p-1,2),p-=2)}e=e.join("/")}if((n||i)&&r){s=e.split("/");for(p=s.length;p>0;p-=1){u=s.slice(0,p).join("/");if(n)for(d=n.length;d>0;d-=1){a=r[n.slice(0,d).join("/")];if(a){a=a[u];if(a){f=a,l=p;break}}}if(f)break;!c&&i&&i[u]&&(c=i[u],h=p)}!f&&c&&(f=c,l=h),f&&(s.splice(0,l,f),e=s.join("/"))}return e}function h(t,n){return function(){return l.apply(e,a.call(arguments,0).concat([t,n]))}}function p(e){return function(t){return c(t,e)}}function d(e){return function(n){t[e]=n}}function v(r){if(n.hasOwnProperty(r)){var i=n[r];delete n[r],u[r]=!0,f.apply(e,i)}if(!t.hasOwnProperty(r))throw new Error("No "+r);return t[r]}function m(e,t){var n,r,i=e.indexOf("!");return i!==-1?(n=c(e.slice(0,i),t),e=e.slice(i+1),r=v(n),r&&r.normalize?e=r.normalize(e,p(t)):e=c(e,t)):e=c(e,t),{f:n?n+"!"+e:e,n:e,p:r}}function g(e){return function(){return o&&o.config&&o.config[e]||{}}}var t={},n={},o={},u={},a=[].slice,f,l;f=function(r,i,s,o){var a=[],f,l,c,p,y,b;o=o||r;if(typeof s=="function"){i=!i.length&&s.length?["require","exports","module"]:i;for(b=0;b<i.length;b++){y=m(i[b],o),c=y.f;if(c==="require")a[b]=h(r);else if(c==="exports")a[b]=t[r]={},f=!0;else if(c==="module")l=a[b]={id:r,uri:"",exports:t[r],config:g(r)};else if(t.hasOwnProperty(c)||n.hasOwnProperty(c))a[b]=v(c);else if(y.p)y.p.load(y.n,h(o,!0),d(c),{}),a[b]=t[c];else if(!u[c])throw new Error(r+" missing "+c)}p=s.apply(t[r],a);if(r)if(l&&l.exports!==e&&l.exports!==t[r])t[r]=l.exports;else if(p!==e||!f)t[r]=p}else r&&(t[r]=s)},r=i=l=function(t,n,r,i){return typeof t=="string"?v(m(t,n).f):(t.splice||(o=t,n.splice?(t=n,n=r,r=null):t=e),n=n||function(){},i?f(e,t,n,r):setTimeout(function(){f(e,t,n,r)},15),l)},l.config=function(e){return o=e,l},s=function(e,t,r){t.splice||(r=t,t=[]),n[e]=[e,t,r]},s.amd={jQuery:!0}}(),s("../tools/almond",function(){}),s("interactives/convert",["underscore"],function(e){function t(t){return e.escape(t)}return t}),s("interactives/base/util",["jquery","d3"],function(e,t){function n(e){if(!e)return{height:0,width:0};var t=e.node().getBBox();return{height:t.height,width:t.width}}function r(e){var n=Math.log(e)/Math.log(10)+1e-6;return Math.abs(n-Math.floor(n))<.1&&Math.floor(n)%2==0?t.round(Math.log(e)/Math.log(10)):""}function i(e){return e?e<0?-1:1:0}function s(e){var t=Array.prototype.slice.call(arguments,1),n=e+"(";return n+=t.join(","),n+=")",n}function o(e,t){return e.id!==undefined?e.id:("autoIdCount"in t||(t.autoIdCount=0),"autoIdPrefix"in t||(t.autoIdPrefix="auto"+ ++o.autoPrefixCount+"_"),t.autoIdPrefix+ ++t.autoIdCount)}function u(e){var t=[];for(var n=e.length-1;n>=0;--n)t[n]={r:Math.random(),element:e[n]};t.sort(function(e,t){return e.r-t.r});for(var n=e.length-1;n>=0;--n)e[n]=t[n].element}function a(e,t){return{height:e,width:t.width*e/t.height}}function f(e,t){return{height:t.height*e/t.width,width:e}}return o.autoPrefixCount=0,{measure:n,logFormat:r,sign:i,attrFnVal:s,getIdFromConfigOrAuto:o,randomizeArray:u,matchRatioWithHeight:a,matchRatioWithWidth:f}}),s("interactives/base/svgcontainer",["jquery","d3"],function(e,t){return{init:function(t){this.parentNode=t.node,this.maxWid=t.maxWid,this.maxHt=t.maxHt;if(this.parentNode.empty())return alert("SVGContainer parent node doesn't exist."),null;this.svgObj=this.parentNode.append("svg").attr("viewBox","0 0 "+this.maxWid+" "+this.maxHt).attr("preserveAspectRatio","xMinYMin meet").style("max-width",this.maxWid+"px").style("max-height",this.maxHt+"px")},append:function(t,n){if(!Array.isArray(t))this.append_one_(t,n);else for(var r=0;r<t.length;++r)r>0&&t[r].setScale(t[0].xScale,t[0].yScale),this.append_one_(t[r],n)},append_one_:function(n,r){r===undefined&&(r={topPercentOffset:0,leftPercentOffset:0,heightPercent:1,widthPercent:1});var i=this.svgObj.append("g").attr("class","widget"),s=t.round(r.heightPercent*this.maxHt),o=t.round(r.widthPercent*this.maxWid);n.draw(i,{height:s,width:o});var u=t.round(r.topPercentOffset*this.maxHt),a=t.round(r.leftPercentOffset*this.maxWid);(u!==0||a!==0)&&i.attr("transform","translate("+a+","+u+")")}}}),s("interactives/button",["jquery"],function(e){return{init:function(n,r){this.id=n.id,this.eventManager=r,this.pressedEventId=this.id+"_Pressed";var i=n.text!==undefined?n.text:"Default text";this.rootEl_=e('<div><button type="button">'+i+"</button></div>");var s=this;e("button",this.rootEl_).click(function(){s.eventManager.publish(s.pressedEventId)})},getRootEl:function(){return this.rootEl_}}}),s("interactives/callouts",["jquery","d3"],function(e,t){return function(){var e={id:"callme",show:"all",type:"numbered",headers:["Nonsense","Reactor steps"],textBits:[{key:"foo",type:"numbered",cols:["bar","1. In a closed circuit, (green) water is pumped at high pressure to the reactor core."]},{key:"foo",cols:["bar","2. Heat is generated by fission in the fuel rods in the reactor core, which heats the circulating water. Thick layers of concrete and steel or lead contain the reactor coreâ€™s radioactivity."]},{key:"foo2",cols:["stuff","3. In the steam generator, the energy from the heated water is used to boil water from a separate supply. The resulting steam moves through a pipe to a turbine."]},{key:"bada",cols:["ish","4. The steam turns the turbine, which is connected to an electricity generator. Power lines distribute the electricity. A typical reactor produces as much as a coal-fired power plant."]},{key:"bing",cols:["credence","5. A third supply of water is used to cool the steam so it condenses into water, which is pumped back to the steam generator."]}]}},{init:function(t,n){this.id=t.id,this.textBits=t.textBits,this.headers=t.headers,this.type=t.type,this.show=t.show,this.eventManager=n,this.selectedEventId=this.id+"_Callout"},draw:function(n){this.node=n;var r=this.textBits.length,i=this;this.rootEl=this.node.append("div").attr("id",this.id);var s=this.rootEl.append("table").attr("class","widgetCallout");if(this.headers){var o=s.append("thead").append("tr");o.selectAll("td").data(this.headers).enter().append("td").html(function(e){return e})}this.calloutCollection=s.append("tbody").selectAll("tr.widgetCallout").data(this.textBits),this.rows=this.calloutCollection.enter().append("tr").attr("class","widgetCallout"),this.calloutCollection.each(function(e,t){e.key="key"in e?e.key:t.toString()}),this.rows.selectAll("td").data(function(e,t){return e.cols}).enter().append("td").html(function(e,t,n){var r="";return i.type=="numbered"&&(r='<span class="stepBadge">'+(n+1)+"</span>"),r+e}),this.show!="all"&&(this.calloutCollection.style("display","none"),t.select("#"+i.id+(i.textBits[0].key?i.textBits[0].key:0)).style("display",null)),this.calloutCollection.on("click",function(e,t){i.eventManager.publish(i.selectedEventId,{selectKey:e.key})})},lite:function n(n){var e=this.calloutCollection;e.classed("lit",!1),this.show!="all"&&e.style("display","none");var t=function(e,t){return e.key===n},r=this.calloutCollection.filter(t);r.style("display",null),r.classed("lit",!0),r.empty()&&console.log("No key '"+n+"' in Labels group "+this.id)}}}),s("interactives/image",["jquery","d3"],function(e,t){return function(){var e={id:"img1",URI:"img/ch4_1.jpg",caption:"The Whitewater-Baldy Complex wildfire.",preserveAspectRatio:"xMinYMin meet",actualSize:{height:960,width:1280},key:"fire"},t={id:"cimg1",image:new Image(e),captionPosition:"below"}},{init:function(t,n){this.id=t.id,this.URI=t.URI,this.caption=t.caption,this.preserveAspectRatio=t.preserveAspectRatio||"xMinYMin meet",this.actualSize=t.actualSize,this.key=t.key,this.childWidgets=[],this.eventManager=n,this.explicitScales_={xScale:null,yScale:null},this.lastdrawn={container:null,size:{height:0,width:0},widgetGroup:null}},autoIdPrefix:function(){var t="img_auto_";return t},draw:function(t,n){this.lastdrawn.container=t,this.lastdrawn.size=n,this.lastdrawn.URI=this.URI,this.lastdrawn.caption=this.caption,this.setLastdrawnScaleFns2ExplicitOrDefault_(n);var r=t.append("g").attr("class","widgetImage").attr("id",this.id);r.append("rect").attr("class","background").attr("width",n.width).attr("height",n.height).attr("fill","#efefef"),r.append("image").attr("xlink:href",this.URI).attr("preserveAspectRatio",this.preserveAspectRatio).attr("width",n.width).attr("height",n.height).append("desc").text(this.caption);var i=6;r.append("rect").attr("class","highlight").attr("width",n.width-i).attr("height",n.height-i).attr("stroke-width",i).attr("x",i/2).attr("y",i/2),this.lastdrawn.widgetGroup=r,this.childWidgets.forEach(this.drawWidget_,this)},redraw:function(){var t=this.lastdrawn.widgetGroup.select("image");t.attr("xlink:href",this.URI);var n=t.select("desc");n.text(this.caption),this.childWidgets.forEach(this.redrawWidget_,this)},drawWidget_:function(t){t.setScale(this.lastdrawn.xScale,this.lastdrawn.yScale),t.draw(this.lastdrawn.widgetGroup,this.lastdrawn.size)},redrawWidget_:function(t){t.redraw()},changeImage:function(t,n){t&&(this.URI=t),n!==undefined&&(this.caption=n)},setScale:function(t,n){this.explicitScales_.xScale=t,this.explicitScales_.yScale=n},append:function(n){e.isArray(n)?n.forEach(this.append_one_,this):this.append_one_(n)},append_one_:function(t){this.childWidgets.push(t),this.lastdrawn.container!==null&&this.drawWidget_(t)},lite:function(t){var n=t===this.key;this.lastdrawn.widgetGroup.classed("lit",n)},setLastdrawnScaleFns2ExplicitOrDefault_:function(n){this.explicitScales_.xScale!==null?this.lastdrawn.xScale=this.explicitScales_.xScale:this.lastdrawn.xScale=t.scale.linear().rangeRound([0,n.width]),this.explicitScales_.yScale!==null?this.lastdrawn.yScale=this.explicitScales_.yScale:this.lastdrawn.yScale=t.scale.linear().rangeRound([n.height,0])}}}),s("interactives/image/captionedimage",["jquery","d3"],function(e,t){return{init:function(t,n){this.id=t.id||"momma",this.image=t.image,this.captionPosition=t.captionPosition,this.eventManager=n,this.lastdrawn={container:null,size:{height:0,width:0},widgetGroup:null}},autoIdPrefix:function(){var t="cimg_auto_";return t},draw:function(t,n){this.lastdrawn.container=t,this.lastdrawn.size=n,this.lastdrawn.URI=this.image.URI,this.lastdrawn.caption=this.image.caption;var r=t.append("g").attr("class","widgetCaptionedImage").attr("id",this.id),i={height:40,width:n.width},s={height:n.height-i.height,width:n.width},o=r.append("g");this.image.draw(o,s);var u=r.append("g");u.append("foreignObject").attr("width",i.width).attr("height",i.height).append("xhtml:body").style("margin","0px").append("div").attr("class","widgetImageCaption").html(this.image.caption),this.captionPosition==="above"?o.attr("transform",this.attrFnVal("translate",0,i.height)):u.attr("transform",this.attrFnVal("translate",0,s.height)),this.lastdrawn.widgetGroup=r},attrFnVal:function(t){var n=Array.prototype.slice.call(arguments,1),r=t+"(";return r+=n.join(","),r+=")",r},redraw:function(){this.image.redraw();var t=this.lastdrawn.widgetGroup.select("g body div").html(this.image.caption)},changeImage:function(t,n){this.image.changeImage(t,n)},setScale:function(t,n){this.image.setScale(t,n)},append:function(t){this.image.append(t)}}}),s("interactives/labelgroup",["jquery","d3"],function(e,t){return function(){var e={id:"lbl1",labels:[{content:"Pre-development",xyPos:[0,-0.25],width:100},{content:"Developing",xyPos:[14,-0.25],width:80},{content:"Modernizing",xyPos:[27,-0.25],width:80},{content:"Developed",xyPos:[40,-0.25],width:70},{content:"Post-development",xyPos:[51,-0.25],width:100}]}},{init:function(t,n){this.id=t.id||"labelgroupid1",this.labels=t.labels,this.type=t.type,this.eventManager=n,this.selectedEventId=this.id+"_labelSelected",this.explicitScales_={xScale:null,yScale:null},this.lastdrawn={container:null,size:{height:0,width:0},labelsId:this.id+"Labels",widgetGroup:null,xScale:null,yScale:null}},autoIdPrefix:function(){var t="lblg_auto_";return t},draw:function(e,t){this.lastdrawn.container=e,this.lastdrawn.size=t,this.setLastdrawnScaleFns2ExplicitOrDefault_(t);var n=this,r=this.labels.length,i=e.append("g").attr("class","widgetLabelGroup").attr("id",this.id);this.lastdrawn.widgetGroup=i;var s=i.selectAll("g.widgetLabel").data(this.labels);s.enter().append("g").attr("class","widgetLabel"),s.each(function(e,t){e.key="key"in e?e.key:t.toString()}),s.attr("transform",function(e,t){return n.attrFnVal("translate",n.lastdrawn.xScale(e.xyPos[0]),n.lastdrawn.yScale(e.xyPos[1]))}),s.append("foreignObject").attr("x",0).attr("y",0).attr("width",function(e){return e.width}).attr("height",200).append("xhtml:body").style("margin","0px").append("div").attr("class","descLabel").html(function(e){return e.content}),(this.type=="bullets"||this.type=="numbered")&&s.append("circle").attr("class","numSteps").attr("r",16).attr("cx",0).attr("cy",0),this.type=="numbered"&&s.append("text").attr("text-anchor","middle").attr("alignment-baseline","middle").text(function(e,t){return t+1}),s.on("click",function(e,t){n.eventManager.publish(n.selectedEventId,{selectKey:e.key})}),this.lastdrawn.labelCollection=i.selectAll("g.widgetLabel")},attrFnVal:function(t){var n=Array.prototype.slice.call(arguments,1),r=t+"(";return r+=n.join(","),r+=")",r},setScale:function(e,t){this.explicitScales_.xScale=e,this.explicitScales_.yScale=t},lite:function(e){console.log("TODO: log fired Label highlite "+e);var t=this.lastdrawn.labelCollection;t.classed("lit",!1);var n=function(t,n){return t.key===e},r=t.filter(n);r.classed("lit",!0),r.empty()&&console.log("No key '"+e+"' in Labels group "+this.id)},setLastdrawnScaleFns2ExplicitOrDefault_:function(e){this.explicitScales_.xScale!==null?this.lastdrawn.xScale=this.explicitScales_.xScale:this.lastdrawn.xScale=t.scale.linear().rangeRound([0,e.width]),this.explicitScales_.yScale!==null?this.lastdrawn.yScale=this.explicitScales_.yScale:this.lastdrawn.yScale=t.scale.linear().rangeRound([e.height,0])},setOpacity:function(e,t,n){var r=this.lastdrawn.xScale,i=this.lastdrawn.yScale,s=this.lastdrawn.labelCollection;s.transition().style("opacity",e).duration(t).delay(n)}}}),s("interactives",["require","jquery","d3","interactives/convert","interactives/base/util","interactives/base/svgcontainer","interactives/button","interactives/callouts","interactives/image","interactives/image/captionedimage","interactives/labelgroup"],function(e){function c(e,t){var n={button:h,callout:p,captionedImage:d,image:v,labelGroup:m,svgContainer:g};if(typeof n[e.xtype]!="function")throw new Error("Invalid bric "+e.xtype);return n[e.xtype](e,t)}function h(e,n){var r={id:e.id,text:e.text},i=Object.create(o);i.init(r,n),t("#"+e.targetid).append(i.getRootEl()),n.subscribe(i.pressedEventId,function(){alert("yay"+e.text)})}function p(e,t){var r=Object.create(u);return r.init(e,t),r.draw(n.select("#"+e.targetid)),r}function d(e,t){var n=v(e.image,t),r=Object.create(f);return r.init({id:e.id,image:n,captionPosition:e.captionPosition}),r}function v(e,t){var n={id:e.targetid,URI:e.URI,caption:e.caption,actualSize:e.actualSize},r=Object.create(a);return r.init(n),r}function m(e,t){var n=Object.create(l);return n.init({id:e.id,type:e.type,labels:e.labels},t),n}function g(e,t){var r=i.matchRatioWithHeight(e.height,e.actualSize),o={node:n.select("#"+e.nodeid),maxSize:r,maxWid:r.width,maxHt:e.maxHt},u=Object.create(s);return u.init(o),u}function y(e,t,n,r){var i={append:b,createFn:w,seedFn:E,subscribe:S};if(typeof i[e.type]!="function")throw new Error("Invalid action "+e.type);return i[e.type](e,t,n,r)}function b(e,t){t[e.to].append(t[e.what],e.config)}function w(e,t){return{bricFn:function(r){e.config.forEach(function(e){t[e.object][e.method](r.selectKey)})}}}function E(e,t,n){n[e.fn].bricFn(e.config)}function S(e,t,n,r){r.subscribe(t[e.object].selectedEventId,n[e.callback].bricFn)}var t=e("jquery"),n=e("d3"),r=e("interactives/convert"),i=e("interactives/base/util"),s=e("interactives/base/svgcontainer"),o=e("interactives/button"),u=e("interactives/callouts"),a=e("interactives/image"),f=e("interactives/image/captionedimage"),l=e("interactives/labelgroup");return{version:"0.0.1, jQuery version is: "+t.fn.jquery,convert:r,init:function(t,n){var r={},i={};t.targetActivity.master.brix.forEach(function(e){e.xtype=="action"?i[e.id]=y(e,r,i,n):r[e.id]=c(e,n)})}}}),s("jquery",function(){return e}),s("underscore",function(){return t}),s("d3",function(){return n}),i("interactives")});